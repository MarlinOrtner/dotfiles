zrccompile() {
  local zfile=$1
  if [[ ! -f "${zfile}.zwc" || "$zfile" -nt "${zfile}.zwc" ]]; then
    zcompile "$zfile"
  fi
}

zrccompile "$HOME/.zshrc"
# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
# Performance optimizations
DISABLE_AUTO_UPDATE="true"
DISABLE_MAGIC_FUNCTIONS="true"
DISABLE_COMPFIX="true"
ZSH_DISABLE_COMPFIX="true"
#if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
#  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
#fi

autoload -Uz vcs_info
precmd() { vcs_info }
precmd_functions+=( precmd_vcs_info )
setopt prompt_subst
RPROMPT='${vcs_info_msg_0_}'
# PROMPT='${vcs_info_msg_0_}%# '
zstyle ':vcs_info:git:*' formats '%b'

# Define the dump file path
ZCOMPDUMP="${ZDOTDIR:-$HOME}/.zcompdump"

# Load compinit
autoload -Uz compinit

# Check if the file exists AND was modified within the last 24 hours (m-1)
# (#qN) makes the glob "quiet" (no error if file is missing)
if [[ -n "$ZCOMPDUMP"(#qN.m-1) ]]; then
  compinit -C
else
  compinit
fi

# Background compile the dump file to .zwc for the next launch
{
  if [[ -s "$ZCOMPDUMP" && (! -s "${ZCOMPDUMP}.zwc" || "$ZCOMPDUMP" -nt "${ZCOMPDUMP}.zwc") ]]; then
    zcompile "$ZCOMPDUMP"
  fi
} &!
# +---------+
# | Options |
# +---------+

# setopt GLOB_COMPLETE      # Show autocompletion menu with globs
setopt MENU_COMPLETE        # Automatically highlight first element of completion menu
setopt AUTO_LIST            # Automatically list choices on ambiguous completion.
setopt COMPLETE_IN_WORD     # Complete from both ends of a word.


{{ if eq .chezmoi.os "darwin" }}
# My System Specifiv Config: Darwin
{{ include "./.zshrc_darwin" }}
{{ else if eq .chezmoi.os "linux" }}
# My System Specifiv Config: Linux
{{ include "./.zshrc_linux" }}
{{ end }}


export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Theme
ZSH_THEME="spaceship"
SPACESHIP_PROMPT_ASYNC=true
SPACESHIP_PROMPT_ADD_NEWLINE=true
SPACESHIP_PROMPT_ORDER=(
	time
	dir
	git
	line_sep
	jobs
  char
)
# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(
    zsh-autosuggestions
    fzf
    fzf-tab
    pyenv-lazy
    zsh-prompt-benchmark
#    zsh-syntax-highlighting
    fast-syntax-highlighting

)

export ZSH="$HOME/.oh-my-zsh"
source $ZSH/oh-my-zsh.sh
# +---------+
# | zstyles |
# +---------+
_comp_options+=(globdots) # With hidden files
# Define completers
zstyle ':completion:*' completer _extensions _complete _approximate

#zstyle ':completion:*' file-list all
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "$XDG_CACHE_HOME/zsh/.zcompcache"
zstyle ':completion:*' complete true

# Allow you to select in a menu
zstyle ':completion:*' menu select

# Autocomplete options for cd instead of directory stack
zstyle ':completion:*' complete-options true

zstyle ':completion:*' file-sort modification

#
zstyle ':completion:*:*:*:*:corrections' format '%F{yellow}!- %d (errors: %e) -!%f'
zstyle ':completion:*:*:*:*:descriptions' format '%F{blue}-- %D %d --%f'
zstyle ':completion:*:*:*:*:messages' format ' %F{purple} -- %d --%f'
zstyle ':completion:*:*:*:*:warnings' format ' %F{red}-- no matches found --%f'
# zstyle ':completion:*:default' list-prompt '%S%M matches%s'
# Colors for files and directory
zstyle ':completion:*:*:*:*:default' list-colors ${(s.:.)LS_COLORS}

# Only display some tags for the command cd
zstyle ':completion:*:*:cd:*' tag-order local-directories directory-stack path-directories
# zstyle ':completion:*:complete:git:argument-1:' tag-order !aliases

# Required for completion to be in good groups (named after the tags)
zstyle ':completion:*' group-name ''

zstyle ':completion:*:*:-command-:*:*' group-order aliases builtins functions commands

# See ZSHCOMPWID "completion matching control"
zstyle ':completion:*' matcher-list '' 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'

zstyle ':completion:*' keep-prefix true

zstyle -e ':completion:*:(ssh|scp|sftp|rsh|rsync):hosts' hosts 'reply=(${=${${(f)"$(cat {/etc/ssh_,~/.ssh/known_}hosts(|2)(N) /dev/null)"}%%[# ]*}//,/ })'
zstyle ':omz:update' frequency 13
# disable sort when completing `git checkout`
zstyle ':completion:*:git-checkout:*' sort false
# set descriptions format to enable group support
# NOTE: don't use escape sequences (like '%F{red}%d%f') here, fzf-tab will ignore them
zstyle ':completion:*:descriptions' format '[%d]'
# set list-colors to enable filename colorizing
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
# force zsh not to show completion menu, which allows fzf-tab to capture the unambiguous prefix
zstyle ':completion:*' menu no
# preview directory's content with eza when completing cd
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'
# custom fzf flags
# NOTE: fzf-tab does not follow FZF_DEFAULT_OPTS by default
zstyle ':fzf-tab:*' fzf-flags '--color=fg:1,fg+:2 --bind=tab:accept'
# To make fzf-tab follow FZF_DEFAULT_OPTS.
# NOTE: This may lead to unexpected behavior since some flags break this plugin. See Aloxaf/fzf-tab#455.
zstyle ':fzf-tab:*' use-fzf-default-opts yes
# switch group using `<` and `>`
zstyle ':fzf-tab:*' switch-group '<' '>'


# Give the kill command a nice header
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=01;31'

# Set up the fzf-tab preview for kill
# This shows the PID, User, and the full Command string in the preview window
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-preview \
  'ps --pid=$word -o user,pid,ppid,cmd --no-headers -w -w'

# Enable multi-select (use Tab to mark multiple processes, then Enter to kill all)
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-flags '--preview-window=down:3:wrap'

# RGA Grep via [CTRL] + [F]
# rga-widget() {
# rga-fzf
# }
# zle -N rga-widget
# bindkey '^F' rga-widget


# Don't put 'git' in your plugins=(...) list.
# Instead, add this to the bottom of your .zshrc:
git() {
    unfunction git
    source $ZSH/plugins/git/git.plugin.zsh
    git "$@"
}



DISABLE_AUTO_TITLE="false"
HIST_STAMPS="mm/dd/yyyy"
# Aliases
alias ls="lsd"
alias ll='ls -liah'
alias vim='nvim'
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias .....="cd ../../../.."
alias dl="cd ~/Downloads"
alias dt="cd ~/Desktop"
alias dc="cd ~/Documents"
alias p="cd ~/Documents/projects"
alias home="cd ~"
alias cd="z"
alias top="gotop"
alias v="nvim"
alias zo="zathura"
alias cz="chezmoi"

# Tools
eval "$(zoxide init zsh)"
eval "$(atuin init zsh)"

#yazi shell wrapper
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	IFS= read -r -d '' cwd < "$tmp"
	[ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
	rm -f -- "$tmp"
}

export EDITOR=nvim
export VISUAL=$EDITOR
