zrccompile() {
  local zfile=$1
  if [[ ! -f "${zfile}.zwc" || "$zfile" -nt "${zfile}.zwc" ]]; then
    zcompile "$zfile"
  fi
}

zrccompile "$ZDOTDIR/.zshrc"

DISABLE_AUTO_UPDATE="true"
DISABLE_MAGIC_FUNCTIONS="true"
DISABLE_COMPFIX="true"
ZSH_DISABLE_COMPFIX="true"


autoload -Uz vcs_info
precmd() { vcs_info }
precmd_functions+=( precmd_vcs_info )
setopt prompt_subst
RPROMPT='${vcs_info_msg_0_}'
zstyle ':vcs_info:git:*' formats '%b'
# +---------+
# | Options |
# +---------+

unsetopt GLOB_COMPLETE      # Show autocompletion menu with globs
unsetopt MENU_COMPLETE        # Automatically highlight first element of completion menu
unsetopt AUTO_LIST            # Automatically list choices on ambiguous completion.
setopt COMPLETE_IN_WORD     # Complete from both ends of a word.


{{ if eq .chezmoi.os "darwin" }}
# My System Specifiv Config: Darwin
{{ include "./dot_config/zsh/.zshrc_darwin" }}
{{ else if eq .chezmoi.os "linux" }}
# My System Specifiv Config: Linux
{{ include "./dot_config/zsh/.zshrc_linux" }}
{{ end }}


export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Theme
ZSH_THEME="spaceship"
SPACESHIP_PROMPT_ASYNC=true
SPACESHIP_PROMPT_ADD_NEWLINE=true
SPACESHIP_PROMPT_ORDER=(
	time
	dir
	git
	line_sep
	jobs
  char
)

plugins=(
#    zsh-autosuggestions
  #  fzf
    pyenv-lazy
    zsh-prompt-benchmark
#    zsh-syntax-highlighting
    fast-syntax-highlighting
    fzf-tab #
)

export ZSH="$HOME/.oh-my-zsh"
source $ZSH/oh-my-zsh.sh

# +---------+
# | zstyles |
# +---------+
_comp_options+=(globdots) # With hidden files

# Define completers
zstyle ':completion:*' completer _extensions _complete _approximate

# Caching
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "$XDG_CACHE_HOME/zsh/.zcompcache"

# Autocomplete options for cd instead of directory stack
zstyle ':completion:*' complete-options true

# Sorting
zstyle ':completion:*' file-sort modification
zstyle ':completion:*:git-checkout:*' sort false

# Formats (Messages/Warnings)
zstyle ':completion:*:*:*:*:corrections' format '%F{yellow}!- %d (errors: %e) -!%f'
zstyle ':completion:*:*:*:*:messages' format ' %F{purple} -- %d --%f'
zstyle ':completion:*:*:*:*:warnings' format ' %F{red}-- no matches found --%f'

# Grouping
zstyle ':completion:*' group-name ''
zstyle ':completion:*:*:-command-:*:*' group-order aliases builtins functions commands

# Matching (Case insensitive, partial word, etc.)
zstyle ':completion:*' matcher-list '' 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' keep-prefix true

# Host completion
zstyle -e ':completion:*:(ssh|scp|sftp|rsh|rsync):hosts' hosts 'reply=(${=${${(f)"$(cat {/etc/ssh_,~/.ssh/known_}hosts(|2)(N) /dev/null)"}%%[# ]*}//,/ })'

# Update OMZ frequency
zstyle ':omz:update' frequency 13

# --- fzf-tab Integration ---

# Use tmux popup
zstyle ':fzf-tab:*' fzf-command ftb-tmux-popup

# Disable standard menu for fzf-tab
zstyle ':completion:*' menu no

# Preview directory content with eza when completing cd
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'

# Set descriptions format for fzf-tab group support
zstyle ':completion:*:descriptions' format '[%d]'

# Enable colors in fzf-tab
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}

# Use fzf default opts
zstyle ':fzf-tab:*' use-fzf-default-opts yes

# Switch group using < and >
zstyle ':fzf-tab:*' switch-group '<' '>'

# Custom fzf flags (Safe Version)
# Uses standard colors and binds Tab to 'down' (cycling) instead of 'accept'
zstyle ':fzf-tab:*' fzf-flags \
  '--color=fg:blue,fg+:white' \
  '--bind=tab:down,shift-tab:up'


# --- Kill Command Specifics ---

# Header colors for kill
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=01;31'

# Preview for kill (PID, User, Command)
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-preview \
  'ps --pid=$word -o user,pid,ppid,cmd --no-headers -w -w'

# Multi-select for kill (Overriding general flags to add preview window settings)
zstyle ':fzf-tab:complete:kill:argument-rest' fzf-flags '--preview-window=down:3:wrap --bind=tab:accept'

# RGA Grep via [CTRL] + [F]
# rga-widget() {
# rga-fzf
# }
# zle -N rga-widget
# bindkey '^F' rga-widget


# Don't put 'git' in your plugins=(...) list.
# Instead, add this to the bottom of your .zshrc:
git() {
    unfunction git
    source $ZSH/plugins/git/git.plugin.zsh
    git "$@"
}



DISABLE_AUTO_TITLE="false"
HIST_STAMPS="mm/dd/yyyy"
# Aliases
alias ls="lsd"
alias ll='ls -liah'
alias vim='nvim'
alias ..="cd .."
alias ...="cd ../.."
alias ....="cd ../../.."
alias .....="cd ../../../.."
alias dl="cd ~/Downloads"
alias dt="cd ~/Desktop"
alias dc="cd ~/Documents"
alias p="cd ~/Documents/projects"
alias home="cd ~"
alias cd="z"
alias top="gotop"
alias v="nvim"
alias zo="zathura"
alias cz="chezmoi"

# Tools
eval "$(zoxide init zsh)"
source $HOME/.atuin/bin/env 
eval "$(atuin init zsh)"

#yazi shell wrapper
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	IFS= read -r -d '' cwd < "$tmp"
	[ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
	rm -f -- "$tmp"
}

export EDITOR=nvim
export VISUAL=$EDITOR

{{ if eq .zmk true }}
eval "$(direnv hook zsh)"
{{end}}
